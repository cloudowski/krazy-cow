image: docker:git

services:
  - docker:dind

# variables:
#   DOCKER_DRIVER: overlay2
#   CONTAINER_IMAGE: registry.gitlab.com/codebabel/$CI_PROJECT_NAME #Workaround https://gitlab.com/gitlab-org/gitlab-ce/issues/23339

stages:
  - test
  - build and publish

test:
  stage: test
  image: golang:1.11
  script:
    - mkdir -p /go/src/gitlab.com/$CI_PROJECT_NAMESPACE
    - cp -r /builds/$CI_PROJECT_NAMESPACE /go/src/gitlab.com/
    - cd /go/src/gitlab.com/$CI_PROJECT_NAMESPACE/trapped-cow
    - go get -d
    - go test ./... -v

build-and-publish:
  stage: build and publish
  before_script:
    - docker login -u $DOCKER_USER -p $DOCKER_PASS
  script:
    # - make buildimg
    - docker build -t cloudowski/trapped-cow .
    - docker push cloudowski/trapped-cow
